[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Bases de datos espaciales con Postgres, PostGIS y QGIS",
    "section": "",
    "text": "NotaCómo usar este libro\n\n\n\nEste es un proyecto Quarto configurado como libro digital. Puede renderizarse a HTML o PDF con quarto render. Cada capítulo incluye notas prácticas para ejecutar sobre la base sig_fedearroz_fna y proyectos QGIS vinculados.\n\n\nDescargar PDF: Descargar libro completo en PDF\n\n  ¿Primera vez con PostGIS? Empieza en el capítulo \"Fundamentos SQL\" y progresa capítulo a capítulo. Las secciones se diseñaron para sesiones de 90 minutos con ejercicios al final.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Bases de datos espaciales con Postgres, PostGIS y QGIS</span>"
    ]
  },
  {
    "objectID": "intro.html",
    "href": "intro.html",
    "title": "Introducción",
    "section": "",
    "text": "Por qué un libro sobre PostGIS\nPostGIS extiende PostgreSQL con funciones espaciales que permiten representar parcelas, canales de riego y coberturas agrícolas. Este libro se centra en prácticas de Fedearroz: mantener datos de veredas, producir reportes cartográficos y conectar analítica con QGIS.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Introducción</span>"
    ]
  },
  {
    "objectID": "intro.html#por-qué-un-libro-sobre-postgis",
    "href": "intro.html#por-qué-un-libro-sobre-postgis",
    "title": "Introducción",
    "section": "",
    "text": "TipObjetivos de aprendizaje\n\n\n\n\nComprender cómo se estructura una base de datos espacial en PostgreSQL.\nPreparar datos de referencia utilizando stg.veredas_raw como ejemplo.\nPublicar análisis reproducibles mediante Quarto y QGIS.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Introducción</span>"
    ]
  },
  {
    "objectID": "intro.html#requisitos-previos",
    "href": "intro.html#requisitos-previos",
    "title": "Introducción",
    "section": "Requisitos previos",
    "text": "Requisitos previos\n\nPostgreSQL 15 o superior con la extensión PostGIS 3.\nCliente psql y permisos para conectarse a sig_fedearroz_fna.\nQGIS 3.34 con soporte para conexiones PostGIS y plantillas de impresión.\nPython 3.10 con librerías geopandas, shapely y psycopg opcionales para ETL.\n\n-- Verificar que PostGIS esté disponible\nSELECT version();\nSELECT PostGIS_Version();",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Introducción</span>"
    ]
  },
  {
    "objectID": "intro.html#flujo-de-trabajo-recomendado",
    "href": "intro.html#flujo-de-trabajo-recomendado",
    "title": "Introducción",
    "section": "Flujo de trabajo recomendado",
    "text": "Flujo de trabajo recomendado\n\nDiseño: modelar tablas y vistas en el esquema stg y documentarlas en ESTRUCTURA_FINAL_BD.md.\nCarga: importar shapefiles con shp2pgsql o pipelines ETL en SQL.\nNormalización: reconstruir staging con stg_veredas_norm_build.sql dentro de una transacción.\nPublicación: generar reportes en consultas/ y mapas en QGIS, exportando versiones QA a reportes_cartografia/.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Introducción</span>"
    ]
  },
  {
    "objectID": "intro.html#convenciones-de-estilo",
    "href": "intro.html#convenciones-de-estilo",
    "title": "Introducción",
    "section": "Convenciones de estilo",
    "text": "Convenciones de estilo\n\nPalabras clave SQL en mayúsculas, identificadores en snake_case.\nGeometrías con SRID declarado geometry(MultiPolygon, 32618).\nSecciones complejas documentadas con comentarios breves --.\n\nLa guía completa mantiene estos lineamientos para asegurar consistencia con los procesos de Fedearroz.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Introducción</span>"
    ]
  },
  {
    "objectID": "fundamentos_sql.html",
    "href": "fundamentos_sql.html",
    "title": "Fundamentos de SQL",
    "section": "",
    "text": "Sintaxis básica\nComprender el patrón SELECT ... FROM ... WHERE ... es clave antes de trabajar con geometrías.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Fundamentos de SQL</span>"
    ]
  },
  {
    "objectID": "fundamentos_sql.html#sintaxis-básica",
    "href": "fundamentos_sql.html#sintaxis-básica",
    "title": "Fundamentos de SQL",
    "section": "",
    "text": "-- Contar veredas registradas por departamento\nSELECT departamento,\n       COUNT(*) AS total_veredas\nFROM stg.veredas_norm\nGROUP BY departamento\nORDER BY total_veredas DESC;\n\nFiltros y ordenamiento\n\nWHERE restringe filas.\nORDER BY ordena resultados; combine con LIMIT para obtener los primeros registros.\nDISTINCT evita duplicados en columnas específicas.\n\n-- Veredas con superficie mayor a 500 hectáreas\nSELECT vereda_nombre,\n       municipio,\n       area_ha\nFROM stg.veredas_norm\nWHERE area_ha &gt; 500\nORDER BY area_ha DESC\nLIMIT 20;",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Fundamentos de SQL</span>"
    ]
  },
  {
    "objectID": "fundamentos_sql.html#funciones-de-agregación",
    "href": "fundamentos_sql.html#funciones-de-agregación",
    "title": "Fundamentos de SQL",
    "section": "Funciones de agregación",
    "text": "Funciones de agregación\nUtilice SUM, AVG, MIN, MAX y COUNT junto con GROUP BY para consolidar información.\n-- Área total por municipio\nSELECT municipio,\n       SUM(area_ha) AS area_total_ha,\n       AVG(area_ha) AS area_promedio_ha\nFROM stg.veredas_norm\nGROUP BY municipio\nORDER BY area_total_ha DESC;",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Fundamentos de SQL</span>"
    ]
  },
  {
    "objectID": "fundamentos_sql.html#expresiones-condicionales",
    "href": "fundamentos_sql.html#expresiones-condicionales",
    "title": "Fundamentos de SQL",
    "section": "Expresiones condicionales",
    "text": "Expresiones condicionales\nCASE permite codificar reglas de negocio dentro de la consulta, manteniendo trazabilidad.\nSELECT vereda_nombre,\n       CASE\n         WHEN area_ha &lt; 50 THEN 'Micro'\n         WHEN area_ha BETWEEN 50 AND 200 THEN 'Pequeña'\n         WHEN area_ha BETWEEN 200 AND 500 THEN 'Media'\n         ELSE 'Grande'\n       END AS categoria_area\nFROM stg.veredas_norm;",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Fundamentos de SQL</span>"
    ]
  },
  {
    "objectID": "fundamentos_sql.html#cte-common-table-expressions",
    "href": "fundamentos_sql.html#cte-common-table-expressions",
    "title": "Fundamentos de SQL",
    "section": "CTE (Common Table Expressions)",
    "text": "CTE (Common Table Expressions)\nLas CTE facilitan pipelines claros y reusables.\nWITH limites AS (\n  SELECT municipio,\n         SUM(area_ha) AS area_total_ha\n  FROM stg.veredas_norm\n  GROUP BY municipio\n),\npor_encima AS (\n  SELECT municipio\n  FROM limites\n  WHERE area_total_ha &gt; 15000\n)\nSELECT v.vereda_nombre, v.municipio, v.area_ha\nFROM stg.veredas_norm v\nJOIN por_encima p USING (municipio)\nORDER BY p.municipio, v.area_ha DESC;",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Fundamentos de SQL</span>"
    ]
  },
  {
    "objectID": "fundamentos_sql.html#buenas-prácticas",
    "href": "fundamentos_sql.html#buenas-prácticas",
    "title": "Fundamentos de SQL",
    "section": "Buenas prácticas",
    "text": "Buenas prácticas\n\nEncapsule consultas frecuentes en vistas.\nEjecute scripts largos dentro de BEGIN; ... ROLLBACK; para validar sin afectar datos.\nVersione su SQL con comentarios de contexto -- Fuente: Servicio 690, corte 2024.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Fundamentos de SQL</span>"
    ]
  },
  {
    "objectID": "postgis_basico.html",
    "href": "postgis_basico.html",
    "title": "Primeros pasos con PostGIS",
    "section": "",
    "text": "Habilitar PostGIS en la base de datos\nVerifique versiones:",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Primeros pasos con PostGIS</span>"
    ]
  },
  {
    "objectID": "postgis_basico.html#habilitar-postgis-en-la-base-de-datos",
    "href": "postgis_basico.html#habilitar-postgis-en-la-base-de-datos",
    "title": "Primeros pasos con PostGIS",
    "section": "",
    "text": "CREATE EXTENSION IF NOT EXISTS postgis;\nCREATE EXTENSION IF NOT EXISTS postgis_topology;\n\nSELECT postgis_version(), postgis_full_version();",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Primeros pasos con PostGIS</span>"
    ]
  },
  {
    "objectID": "postgis_basico.html#geometrías-y-srid",
    "href": "postgis_basico.html#geometrías-y-srid",
    "title": "Primeros pasos con PostGIS",
    "section": "Geometrías y SRID",
    "text": "Geometrías y SRID\nDeclare columnas geométricas con tipo explícito.\nCREATE TABLE IF NOT EXISTS catastro.veredas (\n  vereda_id SERIAL PRIMARY KEY,\n  municipio TEXT NOT NULL,\n  vereda_nombre TEXT NOT NULL,\n  geom geometry(MultiPolygon, 32618)\n);\n\nCargar geometrías desde shapefiles\nUse shp2pgsql dentro de una transacción.\nshp2pgsql -s 32618 Servicio-690/ShapeFile/CRVeredas_2020.shp stg.veredas_raw \\\n  | psql -d sig_fedearroz_fna",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Primeros pasos con PostGIS</span>"
    ]
  },
  {
    "objectID": "postgis_basico.html#funciones-espaciales-clave",
    "href": "postgis_basico.html#funciones-espaciales-clave",
    "title": "Primeros pasos con PostGIS",
    "section": "Funciones espaciales clave",
    "text": "Funciones espaciales clave\n-- Área en hectáreas\nSELECT vereda_nombre,\n       ST_Area(geom) / 10000 AS area_ha\nFROM stg.veredas_norm;\n-- Centroides para etiquetas\nSELECT vereda_nombre,\n       ST_Centroid(geom) AS centroide\nFROM stg.veredas_norm;\n-- Relaciones espaciales\nSELECT a.vereda_nombre AS vereda,\n       b.upa_nombre AS upa,\n       ST_Intersects(a.geom, b.geom) AS intersecta\nFROM stg.veredas_norm a\nJOIN stg.upas_norm b\n  ON ST_Intersects(a.geom, b.geom);",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Primeros pasos con PostGIS</span>"
    ]
  },
  {
    "objectID": "postgis_basico.html#validación-de-geometrías",
    "href": "postgis_basico.html#validación-de-geometrías",
    "title": "Primeros pasos con PostGIS",
    "section": "Validación de geometrías",
    "text": "Validación de geometrías\nSELECT COUNT(*) AS geometria_invalida\nFROM stg.veredas_norm\nWHERE NOT ST_IsValid(geom);\nCorrija geometrías defectuosas con ST_MakeValid dentro de una CTE para evitar actualizaciones parciales.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Primeros pasos con PostGIS</span>"
    ]
  },
  {
    "objectID": "postgis_basico.html#indexación-espacial",
    "href": "postgis_basico.html#indexación-espacial",
    "title": "Primeros pasos con PostGIS",
    "section": "Indexación espacial",
    "text": "Indexación espacial\nCREATE INDEX IF NOT EXISTS idx_veredas_geom\n  ON stg.veredas_norm\n  USING GIST (geom);\nLos índices GiST aceleran búsquedas espaciales y son imprescindibles para QGIS.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Primeros pasos con PostGIS</span>"
    ]
  },
  {
    "objectID": "modelado_espacial.html",
    "href": "modelado_espacial.html",
    "title": "Modelado espacial",
    "section": "",
    "text": "Esquemas y gobernanza\nDocumente relaciones en ESTRUCTURA_FINAL_BD.md y mantenga versiones con etiquetas por corte de Servicio 690.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Modelado espacial</span>"
    ]
  },
  {
    "objectID": "modelado_espacial.html#esquemas-y-gobernanza",
    "href": "modelado_espacial.html#esquemas-y-gobernanza",
    "title": "Modelado espacial",
    "section": "",
    "text": "stg: staging y cargas temporales.\ndm: modelos depurados para análisis.\ncarto: vistas optimizadas para consumo en QGIS.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Modelado espacial</span>"
    ]
  },
  {
    "objectID": "modelado_espacial.html#normalización-de-veredas",
    "href": "modelado_espacial.html#normalización-de-veredas",
    "title": "Modelado espacial",
    "section": "Normalización de veredas",
    "text": "Normalización de veredas\nWITH base AS (\n  SELECT vereda_codigo,\n         municipio,\n         departamento,\n         ST_Multi(ST_SnapToGrid(geom, 0.01)) AS geom\n  FROM stg.veredas_raw\n),\ncon_area AS (\n  SELECT *,\n         ST_Area(geom) / 10000 AS area_ha\n  FROM base\n)\nSELECT vereda_codigo,\n       municipio,\n       departamento,\n       area_ha,\n       geom\nFROM con_area;",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Modelado espacial</span>"
    ]
  },
  {
    "objectID": "modelado_espacial.html#dimensiones-y-hechos",
    "href": "modelado_espacial.html#dimensiones-y-hechos",
    "title": "Modelado espacial",
    "section": "Dimensiones y hechos",
    "text": "Dimensiones y hechos\n\nDimensión vereda: atributos geográficos y administrativos.\nDimensión cultivo: especie, ciclo, fecha de siembra.\nHecho producción: superficie cosechada, rendimiento, campaña.\n\nUse claves sustitutas numéricas y mantenga integridad referencial.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Modelado espacial</span>"
    ]
  },
  {
    "objectID": "modelado_espacial.html#versionamiento-de-datos-espaciales",
    "href": "modelado_espacial.html#versionamiento-de-datos-espaciales",
    "title": "Modelado espacial",
    "section": "Versionamiento de datos espaciales",
    "text": "Versionamiento de datos espaciales\n\nAlmacene cortes en tablas históricas hist.veredas_norm_202412.\nRegistre notas de actualización (fuente, QA, responsable).\nCompare geometrias con ST_Equals y ST_Difference para identificar cambios.\n\nSELECT vereda_codigo,\n       ST_Area(ST_Difference(n.geom, h.geom)) / 10000 AS delta_area_ha\nFROM stg.veredas_norm n\nJOIN hist.veredas_norm_202312 h USING (vereda_codigo)\nWHERE NOT ST_Equals(n.geom, h.geom);",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Modelado espacial</span>"
    ]
  },
  {
    "objectID": "modelado_espacial.html#buenas-prácticas-adicionales",
    "href": "modelado_espacial.html#buenas-prácticas-adicionales",
    "title": "Modelado espacial",
    "section": "Buenas prácticas adicionales",
    "text": "Buenas prácticas adicionales\n\nMantener SRID consistente en todo el pipeline (32618).\nEvitar geometrías mixtas; convierta a MultiPolygon.\nValidar topología cuando se integran coberturas departamentales.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Modelado espacial</span>"
    ]
  },
  {
    "objectID": "etl_geoespacial.html",
    "href": "etl_geoespacial.html",
    "title": "ETL geoespacial",
    "section": "",
    "text": "Pipeline recomendado",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>ETL geoespacial</span>"
    ]
  },
  {
    "objectID": "etl_geoespacial.html#pipeline-recomendado",
    "href": "etl_geoespacial.html#pipeline-recomendado",
    "title": "ETL geoespacial",
    "section": "",
    "text": "BEGIN;\n  -- 1. Limpieza de staging\n  TRUNCATE TABLE stg.veredas_norm;\n\n  -- 2. Reconstrucción con script oficial\n  \\i stg_veredas_norm_build.sql\n\n  -- 3. Validaciones rápidas\n  SELECT COUNT(*) FROM stg.veredas_norm;\n  SELECT COUNT(*) FROM stg.veredas_norm WHERE NOT ST_IsValid(geom);\nROLLBACK; -- Cambie a COMMIT cuando las validaciones pasen",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>ETL geoespacial</span>"
    ]
  },
  {
    "objectID": "etl_geoespacial.html#transformaciones-frecuentes",
    "href": "etl_geoespacial.html#transformaciones-frecuentes",
    "title": "ETL geoespacial",
    "section": "Transformaciones frecuentes",
    "text": "Transformaciones frecuentes\n\nNormalización de nombres: usar INITCAP y diccionarios de equivalencias.\nRemuestreo geométrico: ST_SimplifyPreserveTopology para vistas web.\nEnriquecimiento: unir atributos de uso de suelo, climatología y campañas productivas.\n\nWITH upas AS (\n  SELECT upa_id,\n         municipio,\n         geom\n  FROM stg.upas_norm\n),\nveredas AS (\n  SELECT vereda_codigo,\n         municipio,\n         departamento,\n         geom\n  FROM stg.veredas_norm\n)\nSELECT v.vereda_codigo,\n       v.municipio,\n       u.upa_id,\n       ST_Area(ST_Intersection(v.geom, u.geom)) / 10000 AS area_interseccion_ha\nFROM veredas v\nJOIN upas u\n  ON ST_Intersects(v.geom, u.geom);",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>ETL geoespacial</span>"
    ]
  },
  {
    "objectID": "etl_geoespacial.html#automatización-con-cron",
    "href": "etl_geoespacial.html#automatización-con-cron",
    "title": "ETL geoespacial",
    "section": "Automatización con cron",
    "text": "Automatización con cron\n\nGuarde scripts en ops/ con logs diarios.\nDocumente cada tarea programada en ESTRUCTURA_FINAL_BD.md.\nAplique harden_to_scram.sh antes de distribuir credenciales.",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>ETL geoespacial</span>"
    ]
  },
  {
    "objectID": "etl_geoespacial.html#qa-y-exportes",
    "href": "etl_geoespacial.html#qa-y-exportes",
    "title": "ETL geoespacial",
    "section": "QA y exportes",
    "text": "QA y exportes\n\nCarpeta reportes_cartografia/ para salidas PDF y geopackages.\nCorrer consultas/top_veredas_upas_tolima.sql como smoke test tras cada actualización.\nUsar QGIS para revisar simbología y publicar mapas en GeoPackage.",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>ETL geoespacial</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html",
    "href": "qgis_integracion.html",
    "title": "Integración con QGIS",
    "section": "",
    "text": "Conexión a PostgreSQL desde QGIS",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html#conexión-a-postgresql-desde-qgis",
    "href": "qgis_integracion.html#conexión-a-postgresql-desde-qgis",
    "title": "Integración con QGIS",
    "section": "Ingreso a la base de datos",
    "text": "Versión de QGIS: Verifique que la versión de QGIS esté actualizada, con el fin de asegurar compatibilidad con extensiones y complementos del software.\nVerificación Windows: Verifique el nombre del disco y el usuario de Windows del computador en el que va a establecer la conexión a la base de datos, para realizar las respectivas modificaciones en los scripts de permisos y conexión. Asimismo, compruebe si tiene PostgreSQL instalado en el equipo.\nPreparaciones previas para establecer el túnel de conexión: La base de datos se encuentra almacenada en un servidor de la empresa, por este motivo se debe crear el túnel y poder acceder a este cada vez que vaya a entrar a la base de datos:\n\nDebe contar con la carpeta denominada 1keys y dentro de esta se encuentran los archivos correspondientes a las llaves de su usuario (id_ed_usuario); script_conexion (creación de la conexión al túnel), y script_permisos (para poder leer la llave de acceso al servidor) y el ícono (es un script de conexión para abrir el túnel y al abrirlo solicita la contraseña de acceso al servidor, que es diferente del acceso a la base de datos). En la carpeta dejar única y exclusivamente los archivos del usuario que está configurando.\n\nLa carpeta 1keys se debe copiar en uno de los discos del equipo, reconocer cuál es y renombrarlo en los scripts en caso de ser necesario.\nEn ícono click derecho &gt; Propiedades &gt; Acceso directo, en el apartado de destino aparecerá la dirección en la que se encuentran ubicadas las carpetas de la cofiguración a la base de datos, valide el nombre del disco y cámbielo en caso de ser necesario (-File “Disco\\1keys).\n\nValidar el nombre de usuario de windows y el disco en el script_permisos y script_conexion. Click derecho sobre el archivo dentro de cada una de las carpetas según corresponda &gt; editar en blog de notas &gt; Guardar después de las modificaciones.\nAsimismo, verificar el puerto de conexión. Normalmente es el 5432, pero en caso de tener instalado PostgreSQL en la computadora, se debe cambiar por 15432 en el archivo .conf, en el script_conexion (-L) y en los pasos posteriores en QGIS. No olvide guardar los cambios realizados.\nEjecutar el archivo de script_permisos para que restrinja el acceso de otros usuarios a la base de datos. Diríjase a la carpeta script_permisos &gt; click derecho sobre el archivo que se encuentra dentro de ella &gt; ejecutar en PowerShell. Si es exitoso, vaya a la llave del usuario (id_ed_usuario) &gt; click derecho &gt; Propiedades. Se abrirá una nueva ventana, en la pestaña Seguridad, en el apartado Nombres de grupos o usuarios, debe aparecer únicamente el que le corresponde al usuario de la base de datos, si aparecen otros, la ejecución del script de permisos no fue exitosa.\n\nEl error puede ser porque Windows, por defecto, restringe la ejecución de scripts para su protección ante archivos maliciosos. Por este motivo, esta configuración debe ser modificada temporalmente mediante la línea Set-ExecutionPolicy para que se pueda ejecutar el archivo de permisos y el del ícono para poder entrar a la base de datos.\nAbrir Windows PowerShell como administrador y ejecutar la línea:\nSet-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass\nLuego, escribir S para aceptar el cambio de la directiva de ejecución.\n\nEjecutar en PowerShell el archivo de script_permisos, si sale un error, no han quedado libre de restricciones para la ejecución del script, entonces se deben quitar manualmente como se explica a continuación.\nAbra Windows PowerShell como administrador y digitar:\n# Hace referencia al disco donde se guardó la carpeta 1keys. \nd:\ncd 1keys\n# Para listar los objetos que se encuentran dentro de esa carpeta\nls\ncd script_permisos\n.\\usuario_nombre de usuario.ps1\n\nAhora, vuelva a revisar en la pestaña de seguridad en las propiedades de la llave con los parámetros anteriormente mencionados.\nEstablecimiento del túnel de acceso al servidor:\nAl abrir el íncono del usuario creado en la carpeta, se desplegará una ventana en Windows PowerShell en la que le solicitará la contraseña para el acceso al servidor, digítela aún si no es posible verla en la pantalla y oprima la tecla Enter.\n\nSi es la primera vez, es posible que le salga un mensaje de advertencia, escriba yes, oprima la tecla Enter y digite la contraseña.\n\nIngreso exitoso al servidor cuando aparece el enunciado “Have a lot of fun…”:\n\nSi la conexión no fue exitosa, es posible que aparezcan una serie de mensajes de advertencia como los siguientes:\n\nError en la ruta de ejecución del archivo script_conexion. Puede aparecer porque no se modificó el nombre del disco en la ruta de destino en Propiedades del íncono de conexión. Cierre esa ventana, valide la información, cambie lo necesario y vuelva a intentar establecer la conexión.\n\nPermisos denegados porque no se ha ejecutado el archivo script_permisos\n\nPermisos de red a usuarios remotos. Este mensaje de advertencia puede aparecer por\n\ns\nss\n\ng\ng\ng\nVerificación de acceso a la red: Para comprobar la conectividad al servidor o al puerto (IP del computador) donde se encuentra la base de datos PostgreSQL.\n\nAbra PowerShell de Windows desde el buscador o desde el ejecutador de programas (tecla de Windows+R).\n\nEscriba el siguiente código en Windows PowerShell y oprima Enter desde su teclado:\nTest-NetConnection &lt;IP computador&gt; -Port 5432\n\nEn IP computador digite el código donde se encuentra ubicada la base de datos o el referente al servidor según corresponda (información se encuentra en el archivo pg_service.conf). Por defecto, el puerto es 5432, normalmente no se modifica, sin embargo puede reemplazarlo en caso de ser necesario.\nEl enunciado TRUE indica que sí puede acceder desde su computadora al puerto en el que se encuentra ubicada la base de datos. La conexión está lista para iniciar el proceso de vinculación a la base de datos.\n\nSi no puede conectarse, revise la configuración de los datos del IP del computador o servidor, del puerto, así como la red desde la que está intentando acceder.\n\nArchivo pg_service.conf:\n\nEn primer lugar, compruebe si existe una carpeta denominada postgresql copiando la siguiente ruta en el buscador de archivos de su ordenador:\n%APPDATA%\\postgresql\\\n\n\n\n\n\nSI no existe la carpeta arrojará un error, entonces cree la carpeta denominada postgresql, escribiendo la siguiente ruta en el explorador de archivos:\n%APPDATA%\n\nEn la carpeta creada, guarde el archivo pg_service.conf enviado desde la oficina principal, el cual contiene la configuración de conexión a la base de datos y reconocerá la información consignada durante la creación de la conexión e ingreso:\n\nLa estructura del archivo pg_service.conf es la siguiente:\n[Base de datos] = Nombre del servicio, el cual tendrá el mismo nombre de la base de datos.\nhost=Dirección del servidor al que se conectará el sistema (IP o dirección del dominio).\nport=Puerto de conexión al servicio (base de datos o servidor).\ndbname=Nombre de la base de datos a la que el sistema se conectará. \nsslmode=prefer - Conexión. \n\nActivación de la contraseña maestra y creación de credenciales cifradas\nEste paso es fundamental para proporcionar seguridad a la información que se está visualizando.\nAbra QGIS, en el menú diríjase a Configuración y seleccione Opciones.\n\nEn la ventana desplegada busque Autenticación, le solicitará la contraseña maestra, una clave única implementada por el software QGIS para proteger las credenciales de conexiones como a la base de datos postgreSQL, acuérdese de ella porque en caso de pérdida no se podrá recuperar. Digítela y de click en Aceptar. Vale aclarar que la contraseña maestra y la solicitada para el acceso directamente a la base de datos, son diferentes.\n\nPosteriormente, en la ventana de Autenticación, vaya a Añadir nueva configuración de autenticación y complete los datos solicitados en la ventana desplegada:\n\nNombre: Asigne un nombre a la conexión dentro de QGIS. Sirve como identificador para usted y no afecta la base de datos.\nSeleccione Basic authenthication.\nNombre de usuario: El asignado acorde a la/s zona/s que trabaja.\nContraseña: La asignada para el ingreso a la base de datos.\nLos campos restantes se dejan sin información.\n\n\nCreación de la conexión a PostgreSQL\nEn esta sección se establecerá la conexión a PostgreSQL para tener acceso a la base de datos.\nEn la barra de herramientas busque Administrador de fuentes de datos, en la nueva ventana vaya a Navegador y de click derecho en PostgreSQL. En el menú desplegado, seleccione Conexión nueva.\n\nEnseguida aparecerá la ventana Crear una nueva conexión a PostGIS.\n\nDiligencie los datos que solicitan:\n\nNombre: Asigne un nombre a la conexión dentro de QGIS a la base de datos. Sirve como identificador para usted.\nServicio: Nombre de la base de datos o service name que se encuentra en el archivo pg_service.conf. Diligenciar este campo permite establecer la conexión sin escribir el host, puerto, etc.\nAnfitrión: Dirección del servidor donde se encuentra la base de datos, puede ser el IP del computador o un dominio.\nPuerto: Número del puerto en el que PostgreSQL recibe conexiones. Por defecto es 5432 y normalmente no se cambia.\nBase de datos: Nombre de la base de datos dentro de PostgreSQL a la cual se conectará.\nModo SSL: Seleccionar Preferir.\n\nEn el apartado de Autenticación, de click en Crear una nueva configuración de autenticación y en el menú desplegable seleccione el nombre que asignó previamente en el diligenciamiento de la autenticación (Numeral 4).\nFinalmente, click en Probar conexión, en caso de ser exitosa, podrá observar el enunciado del éxito de la conexión y enseguida diríjase al apartado Ingreso a la base de datos, en caso contrario, continúe en esta sección.\n\nProblema de conexión a PostgreSQL desde QGIS:\nSi no es posible establecer la conexión, diríjase a Windows Powershell y digite el siguiente código para verificar si la conexión entre el equipo desde el que está intentando acceder a la base de datos y el servidor PostgreSQL, es exitosa o no:\nTest-NetConnection &lt;IP computador o servidor &gt; -Port 5432\n\nEl usuario es el referente al de Windows (su cuenta), IP del computador o servidor donde se encuentra ubicada la base de datos y el puerto normalmente es 5432 por defecto, si es necesario modifíquelo.\nTcpTestSucceeded: True incica que la configuración es correcta para aceptar conexiones.\n\nA continuación, en Windows PowerShell digite el código que se encuentra en la parte inferior. Este le permite configurar una variable de entorno en Windows, le indica a QGIS y PostgreSQL la ruta en la que se encuentra guardado el archivo pg_service.conf, debido a que no siempre reconoce dónde encontrar el archivo.\nsetx PGSERVICEFILE \"$Env:APPDATA\\postgresql\\pg_service.conf\"\n\n\nsetx: Comando en PowerShell que le permite crear o modificar variables de entorno permanentes, esos cambios se guardan incluso después de reinicar el equipo.\nPGSERVICEFILE: Nombre de la varaible de entorno que se está creando y es reconocida automáticamente por PostgreSQL (y QGIS, que lo usa). Asimismo, permite indicar la ubicación del archivo pg_service.conf.\n$ENV:APPDATA: Define el valor de la variable, que corresponde a la ruta de acceso al archivo pg_service.conf.\nCORRECTO: se guardó el valor especificado: Variable creada correctamente en el sistema.\n\nAhora, diríjase a Inicio y busque QGIS, en la sección de Carpetas en el menú, seleccione Abrir y de click en OSGeo4W Shell:\n\nEl siguiente código le servirá para probar una conexión a la base de datos PostgreSQL y verificar el usuario que se conectará y la dirección IP, cópielo en la consola de OSGeo4W:\npsql -h &lt;IP computador o servidor&gt; -p 5432 -U &lt;nombre de usuario&gt; -d &lt;nombre base de datos&gt; -c \"SELECT current_user, inet_client_addr();\"\n\nEl código está conformado por caracteres y la información asociada a estos, puede cambiar acorde a la base de datos y repositorio donde se encuentra almacenada. h: host (IP del computador o del servidor); p: puerto; U: usuario de postgreSQL para acceder a la base de datos; d: nombre de la base de datos. Digite la contraseña que le solicitan, en algunos casos no se ve la escritura de la misma, pero sí se está digitando. Si es exitoso, observará el cuadro de la parte inferior izquierda con los datos de su usuario e IP de su computador.\n\nRepita nuevamente el proceso para crear la conexión a PostgreSQL desde QGIS e ingrese a la base de datos.\nIngreso a la base de datos\nUna vez haya establecido la conexión a la base de datos con éxito, ingrese de la siguiente manera: en la barra de herramientas busque Base de datos y en el menú desplegado, seleccione Administrador de bases de datos, herramienta útil para conectarse, explorar (ver tablas, esquemas o capas espaciales) y administrar (ejecutar consultas SQL e importar o exportar datos) diferentes bases de datos espaciales como PostGIS:\n\nSe abrirá una nueva ventana denominada Administrador de BBDD, en la cual se encuentra la barra de menús conformada por Base de datos, Esquema, Tabla y Schema. La barra de herramientas cuenta con las opciones Actualizar, Ventana SQL, Importar capa/archivo y Exportar a archivo. En el panel lateral derecho, se encuentra Proveedores con el listado de los distintos tipos de bases de datos que QGIS maneja. Seleccione PostGIS y en el menú desplegado, observe las bases de datos junto con los esquemas que las conforman.\nUn esquema es considerado como una “carpeta” o “contenedor”, en el que se encuentran las tablas (.csv) y las capas contenidas en la base de datos, permitiendo su administración de una manera organizada. Asimismo, en el panel derecho encontrará la pestaña Info, donde se encuentra la información referente a la conexión, base de datos, esquema o capa seleccionada; Tabla para visualizar los datos de la tabla o capa seleccionada en formato tabular (como una hoja de Excel); y Vista preliminar para previsualizar espacialmente el contenido en caso de tener geometrías.\n\nVaya a PostGIS y seleccione la base de datos en la que se estableció la conexión.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html#cargar-capas-al-lienzo-de-qgis",
    "href": "qgis_integracion.html#cargar-capas-al-lienzo-de-qgis",
    "title": "Integración con QGIS",
    "section": "Cargar capas al lienzo de QGIS",
    "text": "Cargar capas al lienzo de QGIS\nIngrese a la base de datos para visualizar y editar las capas de interés. En la barra de menús seleccione Base de datos &gt; Administrador de bases de datos. En la ventana Administrador de BBDD, diríjase a PostGIS &gt; seleccione la base de datos de interés &gt; esquema que contiene la/s capa/s &gt; click derecho sobre la capa que quiere visualizar o editar &gt; Seleccione Añadir al lienzo. Del mismo modo, se puede añadir una capa al lienzo de QGIS haciendo doble click izquierdo sobre esta.\nNota: La nomenclatura de capas, tablas y otros archivos es fundamental para la consulta de una amplia gama de análisis. Para ello, evite los espacios entre palabras reemplazándolos por guión al piso ( _ ), por ejemplo en vez de escribir “zona llanos”, escriba “zona_llanos”. En el menú desplegado encontrará las capas contenidas en el esquema seleccionado.\n\nUna vez se ha subido la capa, puede visualzarla o editarla como normalmente lo hace desde el software QGIS. No olvide guardar sus cambios.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html#importar-archivos-a-la-base-de-datos",
    "href": "qgis_integracion.html#importar-archivos-a-la-base-de-datos",
    "title": "Integración con QGIS",
    "section": "Importar archivos a la base de datos",
    "text": "Importar archivos a la base de datos\nPara subir a la base de datos PostgreSQL/PostGIS una capa vectorial o una tabla en formato .csv, siga los siguientes pasos:\n\nCapa en formato .gpkg subida en el software QGIS, por ejemplo una capa denominada Puntos.\n\nEn la barra de menús, vaya a Base de datos &gt; Administrador de bases de datos &gt; PostGIS &gt; click sobre la base de datos en la que subirá el archivo &gt; Importar capa/archivo.\n\nEn la ventana Importar capa vectorial se encuentran las siguientes opciones:\n\nEntrada: Hay dos formas de importar el archivo a la base de datos, desde el panel de capas en QGIS o desde el equipo directamente. La primera opción es importar el archivo desde en proyecto QGIS (flechas color rojo): suba la capa o tabla a QGIS y haga click en la barra del menú desplegable, podrá observar las capas que se encuentran en el proyecto, seleccione la que es de su interés. Como segunda alternativa, importe el archivo desde su ordenador (flechas color azul): haga click en el recuadro que tiene tres puntos y búsque la capa y selecciónela.\n\nEn este apartado también se encuentra la opción Importar sólo objetos espaciales seleccionados de la capa que se encuentra en el lienzo, se importarán solo las entidades espaciales que tenga seleccionadas.\n\nEsquema: Seleccione en la base de datos el esquema stg para guardar el archivo a importar, será almacenado como stg.Puntos.\nTabla: Corresponde al nombre de la capa que importará dentro del esquema. Si desea que el nombre sea el mismo que la capa del lienzo, selecciónela en el menú desplegable (recomendado). Si prefiere cambiarlo, escríbalo en este apartado teniendo presente la nota de nomenclartura de archivos.\n\n\nMarque las opciones señaladas con un hasterísco (*) y las que considere pertinentes:\n\nClave primaria: Nombre del campo que actuará como identificador de cada registro, normalmente es el id. Si la capa ya cuenta con esa columna, QGIS puede usarla directamente.\nColumna de geometría*: Define el nombre del campo donde se guardará la geometría espacial (coordenadas de los vectores). Usualmente se denomina geom.\nSRID de origen: Sistema de Referencia de Coordenadas -SRC- que tiene la capa de origen. QGIS puede reconocer el SRC de la capa automáticamente sin necesidad de especificarlo en este apartado.\nSRID de destino*: SRC que tendrá la capa una vez importada, debe ser EPSG:32618 - WGS / UTM zone 18N. Puede conservar el de origen si corresponde a este o reproyectarlo. Es indispensable que las capas importadas estén proyectadas en el SRC anteriormente mencionado, con el fin de que los resultados de los análisis sean correctos y estandarizar procesos.\n\nCodificación*: Defina la codificación del texto, es decir como se guardan los caracteres. Seleccione UFT-8 para asegurar el reconocimiento de tildes y caracteres especiales como la “ñ”.\n\nSustituir las capas de destino (si existe): Sustituye un archivo si tiene el mismo nombre y formato, cualquier dato previo será borrado. Si no selecciona esta opción y la capa tiene el mismo nombre que otra que se encuentra en el esquema, le saldrá un error en la importación.\n\nAsegúrese de que la capa que tiene en el lienzo de QGIS sea la última que importó a la base de datos, debido a que puede hacer análisis erróneos, modificar un archivo dferente o hacer cambios que no corresponden al archivo importado.\nNo estimular a multiparte: Si las capas tienen geometría multi, como multipolígono, QGIS las dividirá en partes simples (polígonos individuales). Por defecto se déjela sin marcar para conservar las geometrías.\nPasar nombres de campos a minúsculas: Reescribe todos los nombres de las columnas a minúsculas.\nCrear índice espacial*: Creación de un índice GiST sobre la columna geom que permite hacer las consultas espaciales de ua manera más eficiente. Seleccione esta opción.\nComentario: Se puede añadir una nota o descripción sobre la capa, el texto se guardará como metadato en la base de datos, es decir que proporcionan información sobre los datos. Podrá apreciar los comentarios en la ventana de Info &gt; Información general.\n\nUna vez tenga la información completa para la importación del archivo, de click en Aceptar y podrá observar un enunciado que le indica el éxito de la importación.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html#exportar-archivos-desde-la-base-de-datos",
    "href": "qgis_integracion.html#exportar-archivos-desde-la-base-de-datos",
    "title": "Integración con QGIS",
    "section": "Exportar archivos desde la base de datos",
    "text": "Exportar archivos desde la base de datos\nLa exportación desde la base de datos PostgreSQL/PostGIS a un disco, puede realizarse desde el panel de capas en QGIS como habitualmente lo hace, o puede hacerlo directamente desde el Administrador de BBDD &gt; Exportar a archivo.\n\nSe abrirá la ventana Exportar a archivo vectorial. En formato, seleccione el de su interés en el menú desplegado; defina la ruta donde desea guardar el archivo en el apartado Guardar como, haciendo click en el recuadro de los tres puntos; en Opciones, defina 32618 como el SRID de destino, Codificación UFT-8 y seleccione si considera sustituir el archivo de destino (si existe). Finalmente, seleccione Aceptar y observará una ventana emergente que le confirma el éxito de la exportación del archivo.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html#consultas-desde-qgis-sql",
    "href": "qgis_integracion.html#consultas-desde-qgis-sql",
    "title": "Integración con QGIS",
    "section": "Consultas desde QGIS SQL",
    "text": "Consultas desde QGIS SQL\n\nConsulta de lotes “00000”en la base de datos:\nSELECT\n      l.lote_id,\n      l.cofinca,\n      l.secuencia_lote,\n      l.lote_codigo,\n      l.municipio_principal,\n      m.mpio_cnmbr AS municipio_nombre,\n      l.area_ha,\n      l.geom\n  FROM gis.lotes AS l\n  LEFT JOIN gis.municipios AS m\n    ON m.mpio_cdpmp = l.municipio_principal\n  WHERE l.cofinca = '00000';\nTop municipios con más lotes\nSELECT\n  l.municipio_principal AS mpio_codigo,   -- Código del municipio tomado desde la tabla de lotes\n  m.mpio_cnmbr         AS mpio_nombre,    -- Nombre del municipio desde gis.municipios\n  COUNT(*)             AS total_lotes,    -- Número de lotes en ese municipio\n  SUM(l.area_ha)       AS area_total_ha   -- Suma de áreas (ha) de los lotes en ese municipio\nFROM gis.lotes AS l\nLEFT JOIN gis.municipios AS m\n  ON m.mpio_cdpmp = l.municipio_principal -- Une por código: si no hay match, el nombre queda NULL (LEFT JOIN)\nGROUP BY\n  l.municipio_principal,                  -- Agrupa por el código del municipio\n  m.mpio_cnmbr                            -- y por el nombre (para tener una fila por municipio)\nORDER BY\n  total_lotes   DESC,                     -- Ordena primero por mayor cantidad de lotes\n  area_total_ha DESC                      -- y como desempate, por mayor área total\nLIMIT 5;\nMuncipios con menor cantidad de lotes por UPA\n/* Los municipios con menor razón entre lotes y UPAs (con al menos 100 lotes) */\nWITH stats AS (\n      SELECT municipio_principal, COUNT(DISTINCT upa_id) AS total_upas\n      FROM gis.upas\n      GROUP BY municipio_principal\n  ),\n  ratios AS (\n      SELECT\n          s.municipio_principal,\n          s.total_upas,\n          l.total_lotes,\n          CASE WHEN s.total_upas &gt; 0\n               THEN l.total_lotes::numeric / s.total_upas\n          END AS razon\n      FROM stats s\n      JOIN (\n          SELECT municipio_principal, COUNT(*) AS total_lotes\n          FROM gis.lotes\n          GROUP BY municipio_principal\n      ) l ON l.municipio_principal = s.municipio_principal\n  )\n  SELECT r.municipio_principal AS mpio_cdpmp,\n         m.mpio_cnmbr,\n         m.dpto_cnmbr,\n         r.total_upas,\n         r.total_lotes,\n         r.razon\n  FROM ratios r\n  JOIN gis.municipios m\n    ON m.mpio_cdpmp = r.municipio_principal\n  WHERE r.total_upas &gt; 0\n    AND r.total_lotes &gt; 100\n  ORDER BY r.razon ASC\n  LIMIT 5;\nMunicipios con mayor cantidad de lotes por UPA\n/* Los municipios con menor cantidad delotes por UPA (con al menos 100 lotes) */\nWITH stats AS (\n      SELECT municipio_principal, COUNT(DISTINCT upa_id) AS total_upas\n      FROM gis.upas\n      GROUP BY municipio_principal\n  ),\n  ratios AS (\n      SELECT\n          s.municipio_principal,\n          s.total_upas,\n          l.total_lotes,\n          CASE WHEN s.total_upas &gt; 0\n               THEN l.total_lotes::numeric / s.total_upas\n          END AS razon\n      FROM stats s\n      JOIN (\n          SELECT municipio_principal, COUNT(*) AS total_lotes\n          FROM gis.lotes\n          GROUP BY municipio_principal\n      ) l ON l.municipio_principal = s.municipio_principal\n  )\n  SELECT r.municipio_principal AS mpio_cdpmp,\n         m.mpio_cnmbr,\n         m.dpto_cnmbr,\n         r.total_upas,\n         r.total_lotes,\n         r.razon\n  FROM ratios r\n  JOIN gis.municipios m\n    ON m.mpio_cdpmp = r.municipio_principal\n  WHERE r.total_upas &gt; 0\n    AND r.total_lotes &gt; 100\n  ORDER BY r.razon DESC\n  LIMIT 5;\nConcentración espacial - lotes más cercanos\nWITH lotes_centroides AS (                           -- CTE 1: punto representativo interior por lote\n  SELECT\n    lote_id,                                         -- Identificador del lote\n    municipio_principal,                             -- Código de municipio del lote\n    CASE\n      WHEN ST_Covers(geom, ST_Centroid(geom))        -- ¿El centroide está dentro o en el borde?\n        THEN ST_Centroid(geom)                       -- Sí: usa el centroide “real”\n      ELSE ST_PointOnSurface(geom)                   -- No: usa un punto garantizado dentro del polígono\n    END AS centro\n  FROM gis.lotes\n),\nnn_por_lote AS (                                     -- CTE 2: distancia al vecino más cercano por lote\n  SELECT\n    c1.municipio_principal,                          -- Trabajamos por municipio (mismo código)\n    c1.lote_id,                                      -- Lote de referencia\n    MIN(ST_Distance(c1.centro, c2.centro))           -- Distancia mínima a otro punto del mismo municipio\n      AS distancia_vecino_m\n  FROM lotes_centroides c1\n  JOIN lotes_centroides c2\n    ON c1.municipio_principal = c2.municipio_principal  -- Solo compara dentro del mismo municipio\n   AND c1.lote_id &lt;&gt; c2.lote_id                         -- Evita compararse consigo mismo\n  GROUP BY c1.municipio_principal, c1.lote_id           -- Una fila por lote con su distancia mínima\n)\nSELECT\n  n.municipio_principal       AS mpio_codigo,        -- Código del municipio\n  m.mpio_cnmbr                AS mpio_nombre,        -- Nombre del municipio\n  COUNT(*)                    AS total_lotes,        -- Cuántos lotes se evaluaron en el municipio\n  AVG(distancia_vecino_m)     AS distancia_media_m,  -- Distancia media al vecino más cercano\n  MIN(distancia_vecino_m)     AS distancia_min_m,    -- Distancia mínima (entre todos los lotes)\n  MAX(distancia_vecino_m)     AS distancia_max_m     -- Distancia máxima (entre todos los lotes)\nFROM nn_por_lote n\nLEFT JOIN gis.municipios m\n  ON m.mpio_cdpmp = n.municipio_principal            -- Trae el nombre (LEFT para no perder municipios)\nGROUP BY n.municipio_principal, m.mpio_cnmbr         -- Agrega métricas a nivel de municipio\nORDER BY\n  distancia_media_m ASC,                             -- Municipios con lotes más “cercanos” primero\n  total_lotes DESC                                   -- Desempate: mayor número de lotes\nLIMIT 10;\nAñada stg.veredas_norm y defina simbología graduada por area_ha.\nWITH lotes_pts AS (                                -- Punto interior por lote (en 32618)\n  SELECT\n    lote_id,\n    municipio_principal,\n    CASE\n      WHEN ST_Covers(geom, ST_Centroid(geom))      -- Si el centroide cae dentro (o borde)…\n        THEN ST_Centroid(geom)                     -- … se usa\n      ELSE ST_PointOnSurface(geom)                 -- …si no, usa un punto garantizado dentro\n    END AS p\n  FROM gis.lotes\n),\nnn AS (                                            -- Vecino más cercano por lote (KNN + DISTINCT ON)\n  SELECT DISTINCT ON (a.lote_id)\n    a.municipio_principal,\n    a.lote_id,\n    ST_Distance(a.p, b.p) AS distancia_vecino_m    -- Metros (geom en 32618)\n  FROM lotes_pts a\n  JOIN lotes_pts b\n    ON a.municipio_principal = b.municipio_principal\n   AND a.lote_id &lt;&gt; b.lote_id\n  ORDER BY a.lote_id, a.p &lt;-&gt; b.p                  -- KNN: primero el más cercano\n),\nagg AS (                                           -- Agregación por municipio (filtra &gt; 100 lotes)\n  SELECT\n    municipio_principal,\n    COUNT(*)                AS total_lotes,        -- N° de lotes con vecino (≈ N° de lotes si N&gt;1)\n    AVG(distancia_vecino_m) AS distancia_media_m,  -- Dispersión media\n    MIN(distancia_vecino_m) AS distancia_min_m,\n    MAX(distancia_vecino_m) AS distancia_max_m\n  FROM nn\n  GROUP BY municipio_principal\n  HAVING COUNT(*) &gt; 100                            -- Solo municipios con &gt; 100 lotes\n)\nSELECT\n  a.municipio_principal AS mpio_codigo,\n  m.mpio_cnmbr          AS mpio_nombre,\n  a.total_lotes,\n  a.distancia_media_m,\n  a.distancia_min_m,\n  a.distancia_max_m\nFROM agg a\nLEFT JOIN gis.municipios m\n  ON m.mpio_cdpmp = a.municipio_principal\nORDER BY a.distancia_media_m DESC, a.total_lotes DESC\nLIMIT 10;                                          -- Ajusta o quita el LIMIT según necesite\nMolino más lejano al lote\nWITH lotes_nearest AS (\n     SELECT\n         l.lote_id,\n         l.municipio_principal,\n         l.departamento_principal,\n         nearest.molino_id,\n         ST_Distance(l.geom, nearest.geom) AS dist_m\n     FROM gis.lotes l\n     CROSS JOIN LATERAL (\n         SELECT mo.molino_id, mo.geom\n         FROM gis.molinos mo\n         ORDER BY l.geom &lt;-&gt; mo.geom\n         LIMIT 1\n     ) AS nearest\n   )\n   SELECT\n       ln.municipio_principal AS mpio_cdpmp,\n       m.mpio_cnmbr,\n       m.dpto_cnmbr,\n       AVG(dist_m)/1000 AS promedio_km,\n       MAX(dist_m)/1000 AS max_km,\n       COUNT(*) AS lotes\n   FROM lotes_nearest ln\n   JOIN gis.municipios m ON m.mpio_cdpmp = ln.municipio_principal\n   GROUP BY ln.municipio_principal, m.mpio_cnmbr, m.dpto_cnmbr\n   ORDER BY promedio_km DESC\n   LIMIT 10;\nAsociar nombre de departamentos a la tabla de lotes\nSELECT l.*, d.dpto_ccdgo\nFROM gis.lotes l\nLEFT JOIN gis.departamentos d \n    ON l.departamento_principal = d.dpto_ccdgo;\nConsulta de un cofinca por zona\nSELECT l.*\nFROM gis.lotes l\n-- Se modifica el cofinca y la zona que se desea consultar\nWHERE cofinca = '99999' AND zona_codigo = 4;",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html#consultas-desde-qgis-sql-1",
    "href": "qgis_integracion.html#consultas-desde-qgis-sql-1",
    "title": "Integración con QGIS",
    "section": "Consultas desde QGIS SQL",
    "text": "Consultas desde QGIS SQL\n\nDato compartido para poder hacer las uniones y diferentes anaálisis.\n\nUtilice el panel DB Manager para ejecutar SQL y crear vistas materiales.\nCREATE MATERIALIZED VIEW carto.v_veredas_fuente_hidrica AS\nWITH fuentes AS (\n  SELECT geom\n  FROM ref.hidrografia_principal\n),\nsimplificado AS (\n  SELECT vereda_codigo,\n         vereda_nombre,\n         municipio,\n         ST_SimplifyPreserveTopology(geom, 5) AS geom\n  FROM stg.veredas_norm\n)\nSELECT s.*, ST_Distance(s.geom, f.geom) AS distancia_m\nFROM simplificado s\nCROSS JOIN LATERAL (\n  SELECT geom\n  FROM fuentes\n  ORDER BY s.geom &lt;-&gt; geom\n  LIMIT 1\n) AS f;\nRecargue la vista en QGIS y configure actualizaciones automáticas tras REFRESH MATERIALIZED VIEW.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html#salidas-cartográficas",
    "href": "qgis_integracion.html#salidas-cartográficas",
    "title": "Integración con QGIS",
    "section": "Salidas cartográficas",
    "text": "Salidas cartográficas\n\nDiseñe plantillas de impresión con logotipo Fedearroz en la esquina inferior.\nExporte mapas en PDF y PNG, guardándolos en reportes_cartografia/ con nomenclatura YYYYMMDD_tema.pdf.\nDocumente estilos QGIS (.qml) en la carpeta consultas/estilos_qgis/.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "qgis_integracion.html#integración-con-quarto",
    "href": "qgis_integracion.html#integración-con-quarto",
    "title": "Integración con QGIS",
    "section": "Integración con Quarto",
    "text": "Integración con Quarto\nInserte mapas renderizados como imágenes o iframe cuando se publique el libro.\n![](reportes_cartografia/20250315_mapa_veredas_tolima.png){fig-align=\"center\"}\nMantenga activos los enlaces relativos para que GitHub Pages genere el sitio correctamente.",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Integración con QGIS</span>"
    ]
  },
  {
    "objectID": "casos_practicos.html",
    "href": "casos_practicos.html",
    "title": "Casos prácticos",
    "section": "",
    "text": "Análisis de veredas con potencial de riego\nIntegre resultados en QGIS para producir mapas temáticos.",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Casos prácticos</span>"
    ]
  },
  {
    "objectID": "casos_practicos.html#análisis-de-veredas-con-potencial-de-riego",
    "href": "casos_practicos.html#análisis-de-veredas-con-potencial-de-riego",
    "title": "Casos prácticos",
    "section": "",
    "text": "Seleccione veredas con proximidad a canales.\nCombine indicadores productivos y accesibilidad.\n\nWITH canales AS (\n  SELECT geom\n  FROM ref.canales_distrito_riego\n),\nveredas AS (\n  SELECT vereda_codigo,\n         municipio,\n         geom,\n         ST_Area(geom) / 10000 AS area_ha\n  FROM stg.veredas_norm\n)\nSELECT v.vereda_codigo,\n       v.municipio,\n       v.area_ha,\n       MIN(ST_Distance(v.geom, c.geom)) AS distancia_canal_m\nFROM veredas v\nCROSS JOIN canales c\nGROUP BY v.vereda_codigo, v.municipio, v.area_ha\nHAVING MIN(ST_Distance(v.geom, c.geom)) &lt; 1500\nORDER BY distancia_canal_m;",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Casos prácticos</span>"
    ]
  },
  {
    "objectID": "casos_practicos.html#monitoreo-de-cambios-interanuales",
    "href": "casos_practicos.html#monitoreo-de-cambios-interanuales",
    "title": "Casos prácticos",
    "section": "Monitoreo de cambios interanuales",
    "text": "Monitoreo de cambios interanuales\nWITH veredas_2024 AS (\n  SELECT vereda_codigo, geom FROM hist.veredas_norm_2024\n),\nveredas_2025 AS (\n  SELECT vereda_codigo, geom FROM stg.veredas_norm\n)\nSELECT v25.vereda_codigo,\n       ST_Area(ST_SymDifference(v24.geom, v25.geom)) / 10000 AS delta_ha\nFROM veredas_2024 v24\nJOIN veredas_2025 v25 USING (vereda_codigo)\nWHERE NOT ST_Equals(v24.geom, v25.geom)\nORDER BY delta_ha DESC;",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Casos prácticos</span>"
    ]
  },
  {
    "objectID": "casos_practicos.html#exportes-qa-automáticos",
    "href": "casos_practicos.html#exportes-qa-automáticos",
    "title": "Casos prácticos",
    "section": "Exportes QA automáticos",
    "text": "Exportes QA automáticos\nCombine scripts SQL con psql y COPY para generar reportes.\npsql -d sig_fedearroz_fna -c \"\\COPY (\n  SELECT vereda_codigo, municipio, area_ha\n  FROM stg.veredas_norm\n  ORDER BY municipio, vereda_codigo\n) TO 'reportes_cartografia/QA_veredas_$(date +%Y%m%d).csv' CSV HEADER\"",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Casos prácticos</span>"
    ]
  },
  {
    "objectID": "casos_practicos.html#integración-con-python-y-geopandas",
    "href": "casos_practicos.html#integración-con-python-y-geopandas",
    "title": "Casos prácticos",
    "section": "Integración con Python y GeoPandas",
    "text": "Integración con Python y GeoPandas\nimport geopandas as gpd\nimport sqlalchemy as sa\n\neninge = sa.create_engine(\"postgresql+psycopg://usuario@localhost/sig_fedearroz_fna\")\nveredas = gpd.read_postgis(\n    \"SELECT vereda_codigo, municipio, geom FROM stg.veredas_norm\",\n    eninge,\n    geom_col=\"geom\"\n)\nveredas.plot(column=\"municipio\", figsize=(10, 8))\nDocumenta los cuadernos asociados dentro de docs/notebooks/ y enlázalos desde este capítulo.",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Casos prácticos</span>"
    ]
  },
  {
    "objectID": "ejercicios.html",
    "href": "ejercicios.html",
    "title": "Ejercicios",
    "section": "",
    "text": "Sesión 1: SQL básico",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Ejercicios</span>"
    ]
  },
  {
    "objectID": "ejercicios.html#sesión-1-sql-básico",
    "href": "ejercicios.html#sesión-1-sql-básico",
    "title": "Ejercicios",
    "section": "",
    "text": "Consultar las cinco veredas más extensas del Tolima.\nIdentificar veredas sin área registrada (area_ha IS NULL).\nCalcular el área promedio por departamento usando CTE.",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Ejercicios</span>"
    ]
  },
  {
    "objectID": "ejercicios.html#sesión-2-geometrías",
    "href": "ejercicios.html#sesión-2-geometrías",
    "title": "Ejercicios",
    "section": "Sesión 2: Geometrías",
    "text": "Sesión 2: Geometrías\n\nCrear una vista con centroides.\nCalcular la distancia mínima a cuerpos de agua.\nGenerar un informe de veredas que se traslapan con áreas protegidas.\n\nWITH protegidas AS (\n  SELECT geom\n  FROM ref.areas_protegidas\n),\nintersecciones AS (\n  SELECT v.vereda_codigo,\n         v.vereda_nombre,\n         v.municipio,\n         ST_Area(ST_Intersection(v.geom, p.geom)) / 10000 AS area_solapada\n  FROM stg.veredas_norm v\n  JOIN protegidas p\n    ON ST_Intersects(v.geom, p.geom)\n)\nSELECT *\nFROM intersecciones\nWHERE area_solapada &gt; 0.5\nORDER BY area_solapada DESC;",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Ejercicios</span>"
    ]
  },
  {
    "objectID": "ejercicios.html#sesión-3-qgis",
    "href": "ejercicios.html#sesión-3-qgis",
    "title": "Ejercicios",
    "section": "Sesión 3: QGIS",
    "text": "Sesión 3: QGIS\n\nConectar QGIS al esquema stg y cargar capas.\nCrear estilos graduados y guardar .qml en consultas/estilos_qgis/.\nPublicar un mapa y exportarlo en PDF.",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Ejercicios</span>"
    ]
  },
  {
    "objectID": "ejercicios.html#sesión-4-automatización",
    "href": "ejercicios.html#sesión-4-automatización",
    "title": "Ejercicios",
    "section": "Sesión 4: Automatización",
    "text": "Sesión 4: Automatización\n\nElaborar un script bash que reconstruya tablas y ejecute consultas.\nConfigurar un cron para generar reportes QA.\nDocumentar hallazgos en reportes_cartografia/README.md.",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Ejercicios</span>"
    ]
  },
  {
    "objectID": "recursos.html",
    "href": "recursos.html",
    "title": "Recursos",
    "section": "",
    "text": "Documentación oficial",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Recursos</span>"
    ]
  },
  {
    "objectID": "recursos.html#documentación-oficial",
    "href": "recursos.html#documentación-oficial",
    "title": "Recursos",
    "section": "",
    "text": "PostgreSQL\nPostGIS\nQGIS",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Recursos</span>"
    ]
  },
  {
    "objectID": "recursos.html#scripts-de-referencia",
    "href": "recursos.html#scripts-de-referencia",
    "title": "Recursos",
    "section": "Scripts de referencia",
    "text": "Scripts de referencia\n\nstg_veredas_norm_build.sql: reconstrucción de veredas normalizadas.\nstg_veredas_reportes.sql: vistas analíticas para reportes.\nconsultas/top_veredas_upas_tolima.sql: validación rápida tras cargas.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Recursos</span>"
    ]
  },
  {
    "objectID": "recursos.html#plantillas-y-estilos",
    "href": "recursos.html#plantillas-y-estilos",
    "title": "Recursos",
    "section": "Plantillas y estilos",
    "text": "Plantillas y estilos\n\nstyles.css: estilos heredados del proyecto GEEMAP para mantener identidad.\nassets/logo_fedearroz.png: logotipo oficial.\nassets/cover.png: portada preparada para GitHub Pages.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Recursos</span>"
    ]
  },
  {
    "objectID": "recursos.html#próximos-pasos",
    "href": "recursos.html#próximos-pasos",
    "title": "Recursos",
    "section": "Próximos pasos",
    "text": "Próximos pasos\n\nAñadir capítulos avanzados sobre análisis raster en PostGIS.\nIncluir ejercicios de QGIS con complementos (Time Manager, Processing).\nDocumentar la arquitectura completa en docs/arquitectura/.",
    "crumbs": [
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Recursos</span>"
    ]
  }
]